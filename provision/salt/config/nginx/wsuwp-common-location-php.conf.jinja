# Nginx location block for all PHP requests.

location ~ \.php$ {
	client_max_body_size {{ salt['pillar.get']('php-config:post_max_size', '150M') }};
	try_files $uri =404;

	# Per https://www.owasp.org/index.php/List_of_useful_HTTP_headers
	#
	# Prevents IE and Google Chrome from MIME-sniffing a response away from the declared
	# content-type.
	add_header X-Content-Type-Options nosniff always;

	# Enable the XSS filter built into modern web browsers. This will re-enable
	# the XSS filter if a user has disabled it.
	add_header X-XSS-Protection "1; mode=block" always;

	# Prevent this page from being loaded in an iframe.
	add_header X-Frame-Options DENY;

	# Set slightly different headers for oEmbed requests
	if ( $embed_request ) {
		add_header X-Frame-Options ALLOWALL;
		add_header X-Content-Type-Options nosniff always;
		add_header X-XSS-Protection "1; mode=block" always;
	}

	include /etc/nginx/wsuwp-common-limit.conf;

	# Include the fastcgi_params defaults provided by nginx
	include /etc/nginx/fastcgi_params;

	{% if 'remote' == salt['pillar.get']('network:location', 'local') %}
	fastcgi_read_timeout 60s;
	{% else %}
	fastcgi_read_timeout 3600s;
	{% endif %}

	# SCRIPT_FILENAME is a required parameter for things to work properly,
	# but was missing in the default fastcgi_params on upgrade to nginx 1.4.
	# We define it here to be sure that it exists.
	fastcgi_param   SCRIPT_FILENAME         $document_root$fastcgi_script_name;

	# Use the upstream for php5-fpm that we defined in nginx.conf
	fastcgi_pass php;

	# And get to serving the file!
	fastcgi_index index.php;
}
